{"version":3,"file":"main.js","sources":["../src/main.ts"],"sourcesContent":["import * as core from '@actions/core'\nimport * as fs from 'fs'\nimport { GitHubService } from './github.js'\nimport {\n  parseConventionalCommit,\n  determineVersionBump,\n  calculateNewVersion,\n  generateChangelog\n} from './version.js'\nimport { PackageManifest, ConventionalCommit, PackageChanges } from './types.js'\nimport path from 'path'\n\n/**\n * The main function for the action.\n *\n * @returns Resolves when the action is complete.\n */\nexport async function run(): Promise<void> {\n  try {\n    const token = core.getInput('token', { required: true })\n    const rootDir = core.getInput('root-dir', { required: false })\n    const manifestFile = core.getInput('manifest-file', { required: true })\n    const createPreRelease = core.getInput('create-prerelease') === 'true'\n    const prereleaseLabel = core.getInput('prerelease-label')\n\n    const github = new GitHubService(token)\n    const labels = await github.getPullRequestLabels()\n\n    // Check if this is a release PR\n    if (labels.includes('release-me')) {\n      core.info('This is a release PR, skipping version calculation')\n      return\n    }\n\n    // Check if this is a prerelease PR\n    const isPreRelease = labels.includes(prereleaseLabel)\n    if (!createPreRelease && isPreRelease) {\n      core.info(\n        'prereleases are disabled and this is a prerelease PR, skipping'\n      )\n      return\n    }\n\n    // Read and parse the manifest file\n    const manifestContent = fs.readFileSync(\n      path.join(rootDir, manifestFile),\n      'utf-8'\n    )\n    const manifest: PackageManifest = JSON.parse(manifestContent)\n\n    const changes: PackageChanges[] = []\n\n    // Process each package in the manifest\n    for (const [packagePath, currentVersion] of Object.entries(manifest)) {\n      // Get commits for this package\n      const commitMessages = await github.getCommitsSinceLastRelease(\n        path.join(rootDir, packagePath)\n      )\n      if (commitMessages.length === 0) {\n        continue\n      }\n\n      // Parse conventional commits\n      const commits: ConventionalCommit[] = commitMessages.map((message) => ({\n        ...parseConventionalCommit(message),\n        hash: '' // We don't need the hash for version calculation\n      }))\n\n      // Determine version bump\n      const bump = determineVersionBump(commits)\n      if (bump === 'none') {\n        continue\n      }\n\n      // Calculate new version\n      const newVersion = calculateNewVersion(currentVersion, bump, isPreRelease)\n\n      // Generate changelog\n      const changelog = generateChangelog(commits)\n\n      changes.push({\n        path: path.join(rootDir, packagePath),\n        currentVersion,\n        newVersion,\n        commits,\n        changelog\n      })\n    }\n\n    if (changes.length === 0) {\n      core.info('No changes requiring version updates found')\n      return\n    }\n\n    // Update package versions and create PR if needed\n    for (const change of changes) {\n      await github.updatePackageVersion(change.path, change.newVersion)\n    }\n\n    if (isPreRelease) {\n      await github.createReleasePullRequest(changes)\n    } else {\n      await github.createRelease(changes)\n    }\n\n    // Set outputs\n    core.setOutput('version', changes[0].newVersion)\n    core.setOutput('prerelease', isPreRelease)\n  } catch (error) {\n    if (error instanceof Error) {\n      core.setFailed(error.message)\n    } else {\n      core.setFailed('An unknown error occurred')\n    }\n  }\n}\n\nrun()\n"],"names":[],"mappings":"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"}